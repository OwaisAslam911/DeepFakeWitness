@inject IHttpContextAccessor HttpContextAccessor

@{
    
    var UserId = HttpContextAccessor.HttpContext.Session.GetInt32("UserId");
}
@{
    ViewData["Title"] = "Profile";
}

<header class="bg-dark text-white text-center py-4 mb-4">
    <h1 class="fw-bold">TruthLens</h1>
    <p class="mb-0">User Profile</p>
</header>

<div class="container">
    <div class="row">
        <!-- Profile Sidebar -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <img src="https://picsum.photos/150/150" alt="User Avatar" class="rounded-circle img-fluid mb-3">
                    <h4 class="fw-bold" id="profileName">Loading...</h4>
                    <p class="text-muted" id="profileEmail">Loading...</p>
                    <p><span id="RoleName" class="badge bg-primary">Loading...</span></p>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <!-- Nav Pills -->
                    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-info-tab" data-bs-toggle="pill" data-bs-target="#pills-info" type="button" role="tab">Profile Info</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-history-tab" data-bs-toggle="pill" data-bs-target="#pills-history" type="button" role="tab">Upload History</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-settings-tab" data-bs-toggle="pill" data-bs-target="#pills-settings" type="button" role="tab">Settings</button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="pills-tabContent">
                        <!-- Profile Info -->
                        <div class="tab-pane fade show active" id="pills-info" role="tabpanel">
                            <h5 class="fw-bold">Personal Information</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><strong>User Name:</strong> <span id="username">loading...</span></li>
                                <li class="list-group-item"><strong>Email:</strong> <span id="useremail">loading...</span></li>
                                <li class="list-group-item"><strong>Role:</strong> <span id="userrole">loading...</span></li>
                       
                            </ul>
                        </div>

                        <!-- Upload History -->
                        <div class="tab-pane fade" id="pills-history" role="tabpanel">
                            <h5 class="fw-bold">Recent Uploads</h5>
                            <table class="table table-hover" id="uploadHistoryTable">
                                <thead>
                                    <tr>
                                        <th>ImageId</th>
                                        <th>Image</th>
                                        <th>Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                   
                                   
                                </tbody>
                            </table>
                        </div>

                        <!-- Settings -->
                        <div class="tab-pane fade" id="pills-settings" role="tabpanel">
                            <h5 class="fw-bold">Account Settings</h5>
                            <form>
                                <div class="mb-3">
                                    <label for="username" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="usernameInput" value="John Doe">
                                </div>
                                <div class="mb-3">
                                    <label for="useremail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="useremailInput" value="john.doe@example.com">
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">New Phone number</label>
                                    <input type="text" class="form-control" id="phoneInput" placeholder="Enter new password">
                                </div>
                                <button type="submit" class="btn btn-primary">Update Profile</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        debugger;
        var userId = "@UserId";  // Razor injects session value here
        console.log("User ID from session:", userId);
        loadUploadHistory(userId);
        // Load profile
        $.get("/UserProfile/GetProfile", { userId: userId }, function (data) {
            console.log(data);
            $("#username").text(data.UserName);
            $("#useremail").text(data.Email);
            $("#profileName").text(data.UserName);
            $("#profileEmail").text(data.Email);
            $("#RoleName").text(data.RoleName);
            $("#userrole").text(data.RoleName);
            $("#usernameInput").val(data.UserName);
            $("#useremailInput").val(data.Email);
            $("#phoneInput").val(data.Phone);
        });

       

        // Update profile
        $("#updateProfileBtn").click(function (e) {
            e.preventDefault();
            var model = {
                userId: userId,
                UserName: $("#username").val(),
                email: $("#useremail").val(),
                passwordHash: $("#password").val() // hash it in real apps
            };

            $.ajax({
                url: "/Profile/UpdateProfile",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(model),
                success: function (res) {
                    if (res.success) {
                        alert("Profile updated successfully!");
                    } else {
                        alert("Update failed.");
                    }
                }
            });
        });
    });


    function loadUploadHistory(userId) {
        $.ajax({
            url: '/UserProfile/GetUploadHistory',
            type: 'GET',
            data: { userId: userId }, // from session
            success: function (history) {
                var tbody = $("#pills-history tbody");
                tbody.empty();

                if (history.length === 0) {
                    tbody.append(`<tr><td colspan="3" class="text-center">No uploads found</td></tr>`);
                } else {
                    $.each(history, function (i, item) {
                        var statusBadge = item.DetectionResult === "Authentic"
                            ? `<span class="badge bg-success">${item.DetectionResult}</span>`
                            : `<span class="badge bg-danger">${item.DetectionResult}</span>`;

                        // 👇 Construct image tag (adjust path if needed)
                        var imageTag = `<img src="/uploads/${item.FileName}"
                                         alt="upload"
                                         class="img-thumbnail"
                                         style="max-width:80px; max-height:80px;">`;

                        tbody.append(`
                        <tr>
                            <td>${item.Id}</td>
                            <td>${imageTag}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `);
                    });
                }
            }
        });


    }

</script>
